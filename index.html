<html>

  <head>


    <button type="button" id="myPuck_connect"> Connect Puck via Bluetooth
    </button>

    <script src="https://www.puck-js.com/puck.js"></script>

    <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>

    <script src="https://cdn.jsdelivr.net/gh/nicolaspanel/numjs@0.15.1/dist/numjs.min.js"></script>

    <script type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.js"></script>
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.css" />
  </head>

  <body>

    <div id="div_g" style="width:1200px; height:600px;"></div>

    <script type="text/javascript">

    $(document).ready(function () {

      var data = [];

      var start_time;

      var connection;

      var xconnect = document.getElementById("myPuck_connect")

      var taxis_increment = 10 * 1000; /// axis increment in milliseconds

      var t = new Date();

      data.push([t, 1000.000]);

      var date_win_min = t.getTime();

      var date_win_max = date_win_min + 2 * taxis_increment;


      var g = new Dygraph(document.getElementById("div_g"), data,

        {

          drawPoints: true,

          showRoller: true,

          digitsAfterDecimal: 3,

          dateWindow: [date_win_min, date_win_max],

          // valueRange: [980, 1020],

          labels: ['Time', 'z-acceleration'],

          showRangeSelector: true

        });


      function onLine(v) {

        v = JSON.parse(v);


        var x = new Date(); // current time

        var y = parseFloat(v['acc']['z']);

        if (x.getTime() >= date_win_max) {

          date_win_min += taxis_increment;

          date_win_max += taxis_increment;

          g.updateOptions({ dateWindow: [date_win_min, date_win_max] });

        };

        data.push([x, y]);

        g.updateOptions({ 'file': data });

        // code to calculate rate. 
        // data is a list with [x,y] sub-lists (x is time, y is z-acc value)
        // to print something for debuggging: use console.log()
        // for numjs functions: use nj.array();
        var acc = nj.array(data).slice([null, 1]);

        var mean = math.mean(acc);

        var norm = Array(acc.length);

        var time = nj.array(data).slice([null,0]);

        var zeroTime = 0;

        var allTimes;

        var diff;

        for (var i = 0; i < acc.length; i++) {
          norm[i] = acc[i] - mean;
          if (i > 0 && norm[i] < 0 && norm[i - 1] > 0) {
            diff = time.get(i) - zeroTime;
            allTimes = nj.Array([allTimes,diff]);
            zeroTime = time.get(i);
          }
        }

        var rate = 1 / math.mean(allTimes);

        console.log(rate)

      }


      function bluetooth_connect() {

        Puck.connect(function (c) {

          // alert("In Puck connect");

          if (!c) {

            alert("Couldn't connect!");

            return;

          }

          connection = c;

          // Handle the data we get back, and call 'onLine'

          // whenever we get a line

          var buf = "";

          connection.on("data", function (d) {

            buf += d;

            var i = buf.indexOf("\n");

            while (i >= 0) {

              onLine(buf.substr(0, i));

              buf = buf.substr(i + 1);

              i = buf.indexOf("\n");

            }

          }); // connection.on ()

          xconnect.textContent = "Disconnect Puck via Bluetooth";

          // Setup data collection and graphing

          data.splice(0, data.length);

          // connection.write("Bluetooth.println(ecg().toFixed(3));} ,20); \n", function () { });
          // connection.write(" \n", function () { });

          t = new Date();

          start_time = t;

          var date_win_min = t.getTime();

          var date_win_max = date_win_min + 2 * taxis_increment;

          g.updateOptions({ dateWindow: [date_win_min, date_win_max] });

        }); // End Puck.connect ()

      }

      xconnect.addEventListener("click", function () { bluetooth_connect() });

    });



  </script>
  </body>

</html>